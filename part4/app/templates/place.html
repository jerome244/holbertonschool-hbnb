{% extends 'base.html' %}

{% block title %}{{ place.title }} - HBnB{% endblock %}

{% block content %}
  <div class="place-detail">
    <!-- Title Section -->
    <div class="place-title">
      <h1>{{ place.title }}</h1>
      <p><strong>Price:</strong> ${{ place.price }} per night</p>
      <p><strong>Views:</strong> {{ place.views }}</p>
    </div>

    <!-- Owner Section (Host) -->
    <div class="place-owner">
      {% if owner %}
        <a href="{{ url_for('views.owner_profile', owner_id=owner.id) }}">
          <img src="{{ url_for('static', filename='uploads/' + (owner.profile_pic if owner.profile_pic else 'default.jpg')) }}" 
               alt="Owner's Profile Picture" class="owner-img">
          {{ owner.pseudo if owner.pseudo else (owner.first_name ~ ' ' ~ owner.last_name) }}
        </a>
      {% else %}
        <p>Unknown</p>
      {% endif %}
    </div>

    <!-- Description and Location Section -->
    <div class="place-description-location">
      <!-- Description Section -->
      <div class="place-description">
        <h3>Description</h3>
        <p>{{ place.description }}</p>
      </div>

      <!-- Location Section -->
      <div class="place-location">
        <h3>Location</h3>
        {% if place.address and place.city %}
          <p><strong>Address:</strong> {{ place.address }}</p>
          <p><strong>City:</strong> {{ place.city }}</p>
        {% else %}
          <p>Location details not provided.</p>
        {% endif %}
      </div>
    </div>

    <!-- Gallery and Map Section -->
    <div class="place-media">
      <div class="place-photos">
        <div id="photoCarousel" class="carousel slide" data-ride="carousel">
          <div class="carousel-inner">
            {% for photo in place.photos %}
              <div class="carousel-item {% if loop.index == 1 %}active{% endif %}">
                <img src="{{ url_for('static', filename='uploads/' + photo.url) }}" 
                     class="d-block w-100" alt="Photo of {{ place.title }} - {{ loop.index }}"
                     onclick="showPhotoModal(this.src)">
              </div>
            {% endfor %}
          </div>

          <!-- Carousel Controls (Previous/Next) -->
          <a class="carousel-control-prev" href="#photoCarousel" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </a>
          <a class="carousel-control-next" href="#photoCarousel" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </a>
        </div>
      </div>

      <!-- Map Container -->
      <div id="map" style="height: 400px;"></div>
    </div>

    <!-- Book Button -->
    <div class="place-booking">
      <a href="{{ url_for('places.booking', place_id=place.id) }}" class="btn btn-primary">Book this place</a>
    </div>

    <!-- Amenities and Reviews Section -->
    <div class="place-amenities-reviews">
      <!-- Amenities Section -->
      <div class="place-amenities">
        <h3>Amenities</h3>
        <ul>
          {% for amenity in place.amenities %}
            <li>{{ amenity.name }}</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Reviews Section -->
      <div class="place-reviews">
        <h3>Reviews</h3>
        {% if place.reviews %}
          <ul>
            {% for review in place.reviews %}
              <li>
                <strong>
                  {% if review.user %}
                    <img src="{{ url_for('static', filename='uploads/' + (review.user.profile_pic if review.user.profile_pic else 'default.jpg')) }}" 
                         alt="Reviewer's Profile Picture" class="user-img">
                    {{ review.user.pseudo or (review.user.first_name ~ ' ' ~ review.user.last_name) }}
                  {% else %}
                    Guest
                  {% endif %}
                </strong>
                rated {{ review.rating }}/5<br>
                {{ review.text }}<br>
                <small>Posted on {{ review.created_at.strftime('%Y-%m-%d') if review.created_at else 'Unknown date' }}</small><br>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p>No reviews yet.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modal for Viewing Larger Photo -->
  <div id="photo-modal" class="photo-modal" aria-hidden="true" onclick="closePhotoModal()">
    <img id="modal-img" class="modal-img" alt="Larger view of the photo">
  </div>

  <!-- Hidden Latitude and Longitude -->
  <input type="hidden" id="latitude" value="{{ place.latitude }}">
  <input type="hidden" id="longitude" value="{{ place.longitude }}">

{% endblock %}

{% block scripts %}
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

  <!-- Leaflet JavaScript -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Custom JavaScript from static/js/modules/ -->
  <script src="{{ url_for('static', filename='js/modules/place.js') }}"></script>
{% endblock %}
